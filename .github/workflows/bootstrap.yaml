name: Flux Bootstrap AKS from Issue

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  issues: read
  id-token: write

jobs:
  flux-bootstrap:
    runs-on: ubuntu-latest
    if: ${{ contains(github.event.comment.body, 'bootstrap') }}

    steps:

      # -----------------------------------------------------------
      # 1. Extract Issue JSON (UNCHANGED PATTERN)
      # -----------------------------------------------------------
      - name: Extract issue JSON
        id: issue
        run: |
          ISSUE_JSON='${{ toJson(github.event.issue) }}'
          {
            echo "data<<EOF"
            echo "$ISSUE_JSON"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      # -----------------------------------------------------------
      # 2. Debug Issue Body
      # -----------------------------------------------------------
      - name: Dump issue body
        run: |
          echo "${{ github.event.issue.body }}"

      # -----------------------------------------------------------
      # 3. Extract values from Issue Form (SAME LOGIC)
      # -----------------------------------------------------------
      - name: Extract values from issue body
        id: extract
        run: |
          ISSUE_BODY="${{ github.event.issue.body }}"

          extract_field() {
            echo "$ISSUE_BODY" | sed -n "/^### $1/{n;n;p;}" | xargs
          }

          echo "aks_rg=$(extract_field 'AKS Resource Group')" >> "$GITHUB_OUTPUT"
          echo "aks_name=$(extract_field 'AKS Cluster Name')" >> "$GITHUB_OUTPUT"
          echo "github_owner=$(extract_field 'GitHub Owner')" >> "$GITHUB_OUTPUT"
          echo "github_repo=$(extract_field 'GitHub Repository')" >> "$GITHUB_OUTPUT"
          echo "github_branch=$(extract_field 'Git Branch')" >> "$GITHUB_OUTPUT"
          echo "flux_path=$(extract_field 'Flux Path')" >> "$GITHUB_OUTPUT"

      # -----------------------------------------------------------
      # 4. Debug parsed values
      # -----------------------------------------------------------
      - name: Debug parsed values
        run: |
          echo "AKS RG:        '${{ steps.extract.outputs.aks_rg }}'"
          echo "AKS Name:      '${{ steps.extract.outputs.aks_name }}'"
          echo "GitHub Owner:  '${{ steps.extract.outputs.github_owner }}'"
          echo "GitHub Repo:   '${{ steps.extract.outputs.github_repo }}'"
          echo "GitHub Branch: '${{ steps.extract.outputs.github_branch }}'"
          echo "Flux Path:     '${{ steps.extract.outputs.flux_path }}'"

      # -----------------------------------------------------------
      # 5. Azure Login (OIDC â€“ FROM SECRETS)
      # -----------------------------------------------------------
      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # -----------------------------------------------------------
      # 6. Get AKS Credentials
      # -----------------------------------------------------------
      - name: Get AKS credentials
        run: |
          az aks get-credentials \
            --resource-group "${{ steps.extract.outputs.aks_rg }}" \
            --name "${{ steps.extract.outputs.aks_name }}" \
            --overwrite-existing

      # -----------------------------------------------------------
      # 7. Install Flux CLI
      # -----------------------------------------------------------
      - name: Install Flux CLI
        run: |
          curl -s https://fluxcd.io/install.sh | sudo bash

      # -----------------------------------------------------------
      # 8. Flux Bootstrap
      # -----------------------------------------------------------
      - name: Flux Bootstrap
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          flux bootstrap github \
            --owner="${{ steps.extract.outputs.github_owner }}" \
            --repository="${{ steps.extract.outputs.github_repo }}" \
            --branch="${{ steps.extract.outputs.github_branch || 'main' }}" \
            --path="${{ steps.extract.outputs.flux_path }}" \
            --personal=false \
            --components-extra=image-reflector-controller,image-automation-controller
