name: Flux Bootstrap AKS (Manual Approval)

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  issues: read

jobs:
  flux-bootstrap:
    runs-on: ubuntu-latest
    environment: flux-bootstrap
    if: contains(github.event.comment.body, '/bootstrap')

    steps:

      # -----------------------------------------------------------
      # 1. Extract values from Issue Form (YOUR WORKING LOGIC)
      # -----------------------------------------------------------
      - name: Extract values from issue body
        id: extract
        run: |
          ISSUE_BODY="${{ github.event.issue.body }}"

          extract_field() {
            echo "$ISSUE_BODY" | sed -n "/^### $1/{n;n;p;}" | xargs
          }

          echo "aks_rg=$(extract_field 'AKS Resource Group')" >> "$GITHUB_OUTPUT"
          echo "aks_name=$(extract_field 'AKS Cluster Name')" >> "$GITHUB_OUTPUT"
          echo "github_owner=$(extract_field 'GitHub Owner')" >> "$GITHUB_OUTPUT"
          echo "github_repo=$(extract_field 'GitHub Repository')" >> "$GITHUB_OUTPUT"
          echo "github_branch=$(extract_field 'Git Branch')" >> "$GITHUB_OUTPUT"
          echo "flux_path=$(extract_field 'Flux Path')" >> "$GITHUB_OUTPUT"

      # -----------------------------------------------------------
      # 2. Azure Login (SERVICE PRINCIPAL)
      # -----------------------------------------------------------
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: |
            {
              "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
              "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
              "tenantId": "${{ secrets.AZURE_TENANT_ID }}",
              "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}"
            }

      # -----------------------------------------------------------
      # 3. Get AKS Credentials
      # -----------------------------------------------------------
      - name: Get AKS credentials
        run: |
          az aks get-credentials \
            --resource-group "${{ steps.extract.outputs.aks_rg }}" \
            --name "${{ steps.extract.outputs.aks_name }}" \
            --overwrite-existing

      # -----------------------------------------------------------
      # 4. Install Flux CLI
      # -----------------------------------------------------------
      - name: Install Flux CLI
        run: |
          curl -s https://fluxcd.io/install.sh | sudo bash

      # -----------------------------------------------------------
      # 5. Flux Bootstrap
      # -----------------------------------------------------------
      - name: Flux Bootstrap
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          flux bootstrap github \
            --owner="${{ steps.extract.outputs.github_owner }}" \
            --repository="${{ steps.extract.outputs.github_repo }}" \
            --branch="${{ steps.extract.outputs.github_branch || 'main' }}" \
            --path="${{ steps.extract.outputs.flux_path }}" \
            --personal=false \
            --components-extra=image-reflector-controller,image-automation-controller
