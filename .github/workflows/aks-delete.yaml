name: Delete AKS Cluster and Resource Group

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  issues: read

jobs:
  aks-delete:
    runs-on: ubuntu-latest
    if: contains(github.event.comment.body, '/delete')

    steps:

      # -----------------------------------------------------------
      # 1. Extract values from Issue Form (SAME LOGIC)
      # -----------------------------------------------------------
      - name: Extract values from issue body
        id: extract
        run: |
          ISSUE_BODY="${{ github.event.issue.body }}"

          extract_field() {
            echo "$ISSUE_BODY" | sed -n "/^### $1/{n;n;p;}" | xargs
          }

          echo "resource_group=$(extract_field 'Resource Group Name')" >> "$GITHUB_OUTPUT"
          echo "aks_name=$(extract_field 'AKS Cluster Name')" >> "$GITHUB_OUTPUT"

      # -----------------------------------------------------------
      # 2. Debug parsed values
      # -----------------------------------------------------------
      - name: Debug parsed values
        run: |
          echo "Resource Group: ${{ steps.extract.outputs.resource_group }}"
          echo "AKS Name:       ${{ steps.extract.outputs.aks_name }}"

      # -----------------------------------------------------------
      # 3. Azure Login (SERVICE PRINCIPAL)
      # -----------------------------------------------------------
      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          client-secret: ${{ secrets.AZURE_CLIENT_SECRET }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # -----------------------------------------------------------
      # 4. Safety Check (FAIL FAST)
      # -----------------------------------------------------------
      - name: Safety check
        run: |
          if [[ -z "${{ steps.extract.outputs.resource_group }}" ]]; then
            echo "‚ùå Resource Group is empty. Aborting."
            exit 1
          fi

      # -----------------------------------------------------------
      # 5. Delete AKS Cluster (best effort)
      # -----------------------------------------------------------
      - name: Delete AKS Cluster
        run: |
          az aks delete \
            --resource-group "${{ steps.extract.outputs.resource_group }}" \
            --name "${{ steps.extract.outputs.aks_name }}" \
            --yes \
            --no-wait || true

      # -----------------------------------------------------------
      # 6. Delete Resource Group (FULL DELETE)
      # -----------------------------------------------------------
      - name: Delete Resource Group
        run: |
          echo "üî• Deleting resource group '${{ steps.extract.outputs.resource_group }}'"
          az group delete \
            --name "${{ steps.extract.outputs.resource_group }}" \
            --yes \
            --no-wait

      # -----------------------------------------------------------
      # 7. Confirmation
      # -----------------------------------------------------------
      - name: Deletion initiated
        run: |
          echo "Deletion started for:"
          echo "- AKS Cluster: ${{ steps.extract.outputs.aks_name }}"
          echo "- Resource Group: ${{ steps.extract.outputs.resource_group }}"
